# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: integ
on:
  pull_request_target:
    types:
      - labeled
      - opened
      - synchronize
      - reopened
      - ready_for_review
  merge_group: {}
jobs:
  determine_env:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      env_name: ${{ steps.output.outputs.env_name }}
    steps:
      - name: Print event output for debugging in case the condition is incorrect
        run: cat $GITHUB_EVENT_PATH
      - name: Start requiring approval
        run: echo IntegTestCredentialsRequireApproval > .envname
      - name: Run automatically if in a mergeGroup or PR created from this repo
        if: ${{ github.event_name == 'merge_group' || github.event.pull_request.head.repo.full_name == github.repository }}
        run: echo IntegTestCredentials > .envname
      - name: Output the value
        id: output
        run: echo "env_name=$(cat .envname)" >> "$GITHUB_OUTPUT"
  integ:
    needs: determine_env
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment: ${{needs.determine_env.outputs.env_name}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: yarn
      - name: Yarn install
        run: yarn install --frozen-lockfile
      - name: Run integration tests
        run: yarn integ
